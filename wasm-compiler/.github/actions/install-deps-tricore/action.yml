name: "Install Tricore Dependencies on Linux"
description: "Install dependencies for Tricore cross-compilation on x86_64 host"

runs:
  using: "composite"
  steps:
    - name: Install tricore dependencies
      shell: bash
      run: |
        apt-get update -y -qq
        apt-get install -y --no-install-recommends \
        build-essential ca-certificates cmake git jq clang llvm llvm-18-tools libclang-rt-18-dev clang-tidy \
        python-is-python3 gcovr wget python3-dev python3-venv python3 python3-pip p7zip-full \
        libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev software-properties-common libdebuginfod-dev

    - name: Install binaryen
      shell: bash
      run: |
        wget https://github.com/WebAssembly/binaryen/releases/download/version_122/binaryen-version_122-x86_64-linux.tar.gz
        tar -xzf binaryen-version_122-x86_64-linux.tar.gz
        echo "$PWD/binaryen-version_122/bin" >> $GITHUB_PATH

    - name: Install Python 3.10 for tricore gdb
      shell: bash
      run: |
        add-apt-repository -y ppa:deadsnakes/ppa
        apt-get update -y
        apt-get install -y python3.10 python3.10-dev
        update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1
        update-alternatives --install /usr/bin/python python /usr/bin/python3.10 2
        update-alternatives --set python /usr/bin/python3.10

    - name: Install wabt
      shell: bash
      run: |
        wget https://github.com/WebAssembly/wabt/releases/download/1.0.36/wabt-1.0.36-ubuntu-20.04.tar.gz
        tar -xzf wabt-1.0.36-ubuntu-20.04.tar.gz
        echo "$PWD/wabt-1.0.36/bin" >> $GITHUB_PATH

    - name: Install tricore gcc
      shell: bash
      run: |
        git clone --depth=1 https://github.com/volumit/tricore_gcc940_linux_bins.git
        cd tricore_gcc940_linux_bins
        7z x tricore_940_linux.zip.001
        chmod -R 777 tricore_940_linux
        ln -s $(pwd)/tricore_940_linux/bin/tricore-elf-gcc /usr/bin/tricore-elf-gcc
        ln -s $(pwd)/tricore_940_linux/bin/tricore-elf-g++ /usr/bin/tricore-elf-g++

    - name: Install tricore qemu
      shell: bash
      run: |
        wget https://github.com/Schleifner/qemu/releases/download/release-tc18-2/qemu-system-tricore
        chmod +x qemu-system-tricore
        mv qemu-system-tricore /usr/local/bin/qemu-system-tricore

    - name: Install Googletest
      shell: bash
      run: |
        git clone --depth 1 --branch release-1.11.0 https://github.com/google/googletest.git \
        && cd googletest && mkdir build && cd build && cmake .. && make -j $(nproc) && make install

    - name: Install tricore gdb
      shell: bash
      run: |
        wget https://github.com/Schleifner/gdb-tricore/releases/download/release-v10.0.50/gdb-tricore-linux-amd64.tar.gz
        mkdir -p gdb-tricore-linux-amd64
        tar -xzf gdb-tricore-linux-amd64.tar.gz -C gdb-tricore-linux-amd64
        mv gdb-tricore-linux-amd64/bin/tricore-elf-gdb /usr/bin/tricore-elf-gdb
        chmod +x /usr/bin/tricore-elf-gdb
        cp -r gdb-tricore-linux-amd64/share/gdb/* /usr/share/gdb/
